<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Grid Magic</title>
    <style>
        canvas {
            border: 1px solid #333;
            background-color: #f4f4f4;
        }
        #controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h2>Grid Magic</h2>
<canvas id="gridCanvas" width="600" height="600"></canvas>
<div id="controls">
    <button onclick="generate()">üîÅ –ú–∞–≥–∏—á–µ—Å–∫–∞—è –∫–Ω–æ–ø–∫–∞</button>

    <!-- –ù–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª -->
    <div style="margin-top: 10px;">
        <label for="shapeSelect">–ò—Å–∫–∞—Ç—å —Ñ–∏–≥—É—Ä—É:</label>
        <select id="shapeSelect">
            <option value="—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫">—Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</option>
            <option value="—á–µ—Ç—ã—Ä—ë—Ö—É–≥–æ–ª—å–Ω–∏–∫">—á–µ—Ç—ã—Ä—ë—Ö—É–≥–æ–ª—å–Ω–∏–∫</option>
            <option value="—Ñ—Ä–∞–≥–º–µ–Ω—Ç">—Ñ—Ä–∞–≥–º–µ–Ω—Ç</option>
            <option value="–æ—Ç—Ä–µ–∑–æ–∫">–æ—Ç—Ä–µ–∑–æ–∫</option>
            <option value="—Ç–æ—á–∫–∞">—Ç–æ—á–∫–∞</option>
            <option value="–ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫">–ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫</option>
            <option value="—à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫">—à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫</option>
        </select>
        <button onclick="findFigure()">üîç –ò—Å–∫–∞—Ç—å —Ñ–∏–≥—É—Ä—É</button>
        <button onclick="stopSearch()">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <p id="info"></p>
</div>

<script>
    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d');
    const size = 10;
    const step = canvas.width / size;
    const origin = { x: canvas.width / 2, y: canvas.height / 2 };

    let searchActive = false;

    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;

        for (let i = 0; i <= size; i++) {
            let pos = i * step;
            ctx.beginPath();
            ctx.moveTo(pos, 0);
            ctx.lineTo(pos, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, pos);
            ctx.lineTo(canvas.width, pos);
            ctx.stroke();
        }

        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;

        ctx.beginPath();
        ctx.moveTo(origin.x, 0);
        ctx.lineTo(origin.x, canvas.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, origin.y);
        ctx.lineTo(canvas.width, origin.y);
        ctx.stroke();
    }

    function toCanvasCoord(x, y) {
        return {
            x: origin.x + x * step,
            y: origin.y - y * step
        };
    }

    function drawPoint(x, y, color) {
        const c = toCanvasCoord(x, y);
        ctx.fillStyle = color || 'black';
        ctx.beginPath();
        ctx.arc(c.x, c.y, 5, 0, 2 * Math.PI);
        ctx.fill();

        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.fillText(`(${x}, ${y})`, c.x + 6, c.y - 6);
    }

    function drawLine(fromPoint, toPoint) {
        const c1 = toCanvasCoord(fromPoint.x, fromPoint.y);
        const c2 = toCanvasCoord(toPoint.x, toPoint.y);
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(c1.x, c1.y);
        ctx.lineTo(c2.x, c2.y);
        ctx.stroke();
    }

    async function generate() {
        const infoEl = document.getElementById('info');
        infoEl.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

        try {
            const response = await fetch('/api/generate');
            if (!response.ok) throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É');

            const data = await response.json();

            drawGrid();
            const points = data.points;
            const edges = data.edges;

            points.forEach(p => drawPoint(p.x, p.y, p.color));

            edges.forEach(edge => {
                const from = points[edge.from];
                const to = points[edge.to];
                drawLine(from, to);
            });

            infoEl.textContent = '–§–∏–≥—É—Ä–∞: ' + data.type;
            return data.type;

        } catch (e) {
            infoEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
            console.error(e);
            return null;
        }
    }

    async function findFigure() {
        const desiredType = document.getElementById('shapeSelect').value;
        searchActive = true;
        const infoEl = document.getElementById('info');
        infoEl.textContent = '–ü–æ–∏—Å–∫ —Ñ–∏–≥—É—Ä—ã: ' + desiredType;

        async function loop() {
            if (!searchActive) return;
            const type = await generate();

            if (type && type.includes(desiredType)) {
                infoEl.textContent = '–ù–∞–π–¥–µ–Ω–∞ —Ñ–∏–≥—É—Ä–∞: ' + type;
                searchActive = false;
            } else {
                setTimeout(loop, 600); // –ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 600 –º—Å
            }
        }

        loop();
    }

    function stopSearch() {
        searchActive = false;
        document.getElementById('info').textContent = '–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
    }

    drawGrid();
</script>
</body>
</html>
