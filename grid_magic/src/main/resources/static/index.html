<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Grid Magic</title>
    <style>
        canvas {
            border: 1px solid #333;
            background-color: #f4f4f4;
        }
        #controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h2>Grid Magic</h2>
<canvas id="gridCanvas" width="600" height="600"></canvas>
<div id="controls">
    <button onclick="generate()">Generate</button>

    <div style="margin-top: 10px;">
        <label for="shapeSelect">Find figure:</label>
        <select id="shapeSelect">
            <option value="point">point</option>
            <option value="segment">segment</option>
            <option value="fragment">fragment</option>
            <option value="triangle: right">right triangle</option>
            <option value="triangle: isosceles">isosceles triangle</option>
            <option value="triangle: scalene">scalene triangle</option>
            <option value="quadrilateral: square">square</option>
            <option value="quadrilateral: rectangle">rectangle</option>
            <option value="quadrilateral: rhombus">rhombus</option>
            <option value="quadrilateral: trapezoid">trapezoid</option>
            <option value="quadrilateral: general">general quadrilateral</option>
            <option value="pentagon">pentagon</option>
            <option value="hexagon">hexagon</option>
        </select>
        <button onclick="findFigure()">Find</button>
        <button onclick="stopSearch()">Stop</button>
    </div>

    <p id="info"></p>
</div>

<script>
    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d');
    const size = 10;
    const step = canvas.width / size;
    const origin = { x: canvas.width / 2, y: canvas.height / 2 };
    let searchActive = false;

    function drawGrid() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        for (let i = 0; i <= size; i++) {
            let pos = i * step;
            ctx.beginPath();
            ctx.moveTo(pos, 0);
            ctx.lineTo(pos, canvas.height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, pos);
            ctx.lineTo(canvas.width, pos);
            ctx.stroke();
        }
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(origin.x, 0);
        ctx.lineTo(origin.x, canvas.height);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(0, origin.y);
        ctx.lineTo(canvas.width, origin.y);
        ctx.stroke();
    }

    function toCanvasCoord(x, y) {
        return {
            x: origin.x + x * step,
            y: origin.y - y * step
        };
    }

    function drawPoint(x, y, color) {
        const c = toCanvasCoord(x, y);
        ctx.fillStyle = color || 'black';
        ctx.beginPath();
        ctx.arc(c.x, c.y, 5, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.fillText(`(${x}, ${y})`, c.x + 6, c.y - 6);
    }

    function drawLine(fromPoint, toPoint) {
        const c1 = toCanvasCoord(fromPoint.x, fromPoint.y);
        const c2 = toCanvasCoord(toPoint.x, toPoint.y);
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(c1.x, c1.y);
        ctx.lineTo(c2.x, c2.y);
        ctx.stroke();
    }

    async function generate() {
        const infoEl = document.getElementById('info');
        infoEl.textContent = 'Generating...';
        try {
            const response = await fetch('/api/generate');
            if (!response.ok) throw new Error('Server returned an error');
            const data = await response.json();
            drawGrid();
            const points = data.points;
            const edges = data.edges;
            points.forEach(p => drawPoint(p.x, p.y, p.color));
            edges.forEach(edge => {
                const from = points[edge.from];
                const to = points[edge.to];
                drawLine(from, to);
            });
            infoEl.textContent = 'Figure: ' + data.type;
            return data.type;
        } catch (e) {
            infoEl.textContent = 'Error: ' + e.message;
            console.error(e);
            return null;
        }
    }

    async function findFigure() {
        const desiredType = document.getElementById('shapeSelect').value;
        searchActive = true;
        const infoEl = document.getElementById('info');
        infoEl.textContent = 'Searching for: ' + desiredType;
        async function loop() {
            if (!searchActive) return;
            const type = await generate();
            if (type && type.includes(desiredType)) {
                infoEl.textContent = 'Found: ' + type;
                searchActive = false;
            } else {
                setTimeout(loop, 600);
            }
        }
        loop();
    }

    function stopSearch() {
        searchActive = false;
        document.getElementById('info').textContent = 'Search stopped';
    }

    drawGrid();
</script>
</body>
</html>
